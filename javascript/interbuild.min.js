/**
 * Created with ShrekSrg.
 * DateTime: 12-9-27 下午2:04
 * Mobile: 13651963992
 * QQ: 284415378
 */
;
(function (e) {
    var t = e.data, n = {method:{}, events:{}, config:{}, CartItemId:-1};
    n.config = e.config, n.Cart = new Array, n.method.getSelection = function () {
        var e = new Array;
        return $("li[selectRole]").each(function (t) {
            e.push($(this).data("data"))
        }), e
    }, n.method.getSelection2 = function (e) {
        var t = new Array, n = 2, r = 1;
        return $("li[selectRole]").each(function (i) {
            var s = $(this).data("data");
            s.category == "shelf" && (n = s.levels), r = n * e;
            if (s.category == "clapboard") {
                for (var i = 0; i < r; i++)t.push(s);
                return
            }
            t.push(s)
        }), t
    }, n.method.getImagePath = function () {
        var e, t = new Array(0, 0), n = new Array;
        return $("li[selectRole]").each(function () {
            var r = $(this).data("data");
            switch (r.category) {
                case"shelf":
                    e = r.dir;
                    for (var i = 0; i < r.levels; i++)n[i] = 0;
                    break;
                case"clapboard":
                    r.type == "back" ? t[0] = r.color : t[1] = r.color;
                    break;
                case"accessory":
                    n[r.tier] = r.type
            }
        }), {dir:e, clapboard:t, accessory:n}
    }, n.method.setImagePath = function (e) {
        var t = n.method.getImagePath();
        return t.dir + "/" + e + ".[" + t.clapboard + "].[" + t.accessory + "]"
    }, n.method.updateBillOptions = function () {
        $("tr[billRole]").find("td[label=count],td[label=gross]").html(0), $.each(n.Cart, function (e, t) {
            $.each(t, function (e, t) {
                var n = $("tr[billRole=" + t.category + "][rid=" + t.id + "]"), r = n.find("td[label=count]"), i = n.find("td[label=gross]"), s = parseInt(r.html()) + 1;
                r.html(s), i.html(t.price * s)
            })
        });
        var e = 0;
        $("td[label=gross]").each(function () {
            e += parseFloat($(this).html())
        }), $("input[label=total]").val(e)
    }, n.method.cancelEdition = function () {
        var e = $("#produit_list_more");
        n.events.initSelection(t.Shelf[0]), $("#produit_list_main ul").find("li a").removeClass("this").eq(0).addClass("this"), e.find("ul:lt(2) li:gt(0) a[class*=this]").removeClass("this"), $("#sca-tagCategory").hide(), e.find("ul:gt(1)").hide().find("li:gt(0) a[class*=this]").removeClass("this"), n.events.initSelectDescribe(), n.events.initPreviewFull()
    }, n.method.setCartPosition = function () {
        var e = $("#main"), t = e.offset().top, n = e.offset().left;
        $("#sca-cart").offset({top:t, left:n + e.width() + 2})
    }, n.method.jsonParse = function (e) {
        return JSON.parse(JSON.stringify(e))
    }, n.events.initPreviewFull = function () {
        var e = n.method.getImagePath(), t = e.dir, r = ".[" + e.clapboard + "].[" + e.accessory + "]" + n.config.suffixPng;
        $("#head_right img").attr("src", t + "/" + "right" + r), $("#head_middle img").attr("src", t + "/" + "middle" + r), $("#head_left img").attr("src", t + "/" + "left" + r)
    }, n.events.initSelection = function (e) {
        var t = e.dir + "/" + e.icon + n.config.suffixPng, r = '<li selectRole="' + e.category + '" class="rack1"><img  src="' + t + '"></li>';
        $("#nav ul").empty().append(r).find("li").data("data", e)
    }, n.events.initSheets = function (e) {
        $("#produit_list_main ul li:first a").addClass("this"), $.each(e, function (e, t) {
            var r = t.dir + "/" + t.icon + n.config.suffixPng, i = $("#produit_list_main ul li").eq(e);
            i.find("a img").attr("src", r), i.data("data", t)
        })
    }, n.events.initClapboardOptions = function (e) {
        var t, r, i = $("#produit_list_more ul");
        $.each(e, function (e, s) {
            e == 0 && (r = s.type), s.type == r ? t = 0 : t = 1;
            var o = n.config.Clapboards.dir + "/" + s.icon + n.config.suffixPng, u = '<li><a href="###"><img src="' + o + '" height="48"></a></li>';
            i.eq(t).append(u), i.eq(t).find("li:last").data("data", s)
        })
    }, n.events.initAccessoryOptions = function (e, t) {
        var r = $("#produit_list_more");
        r.find("ul:gt(1)").remove();
        for (var i = 0; i < e; i++) {
            var t = n.method.jsonParse(t), s = '<ul class="clearfix produit_list_more3 mt10 js_product_more_inner" style="display: none"><li class="wd30  mt10">L' + i + "</li></ul>";
            r.append(s);
            var o = r.find("ul:last");
            $.each(t, function (e, t) {
                var r = n.config.Accessory.dir + "/" + t.icon + n.config.suffix, s = '<li><a class="mr10" href="###"><img src="' + r + '" height="32"></a></li>';
                o.append(s), t.tier = i, o.find("li:last").data("data", t)
            })
        }
    }, n.events.initAccessoryOptions2 = function (e) {
        var t = $("li[selectRole=shelf]").data("data"), r = t.levels, i = t.type, s = $("#produit_list_more");
        s.find("ul:gt(1)").remove();
        for (var o = r; o > 0; o--) {
            var e = n.method.jsonParse(e), u = '<ul class="clearfix produit_list_more3 mt10 js_product_more_inner" style="display: none"><li class="wd30  mt10">L' + o + "</li></ul>";
            s.append(u);
            var a = s.find("ul:last");
            $.each(e, function (e, t) {
                if (t.type != "glass" && t.size != i)return;
                var r = n.config.Accessory.dir + "/" + t.icon + n.config.suffix, s = '<li><a class="mr10" href="###"><img src="' + r + '" height="32"></a></li>';
                a.append(s), t.tier = o - 1, a.find("li:last").data("data", t)
            })
        }
    }, n.events.initSelectDescribe = function () {
        $("#sca-selection-summary").empty();
        var e = 2, t;
        $("li[selectRole]").each(function () {
            var n = $(this).data("data"), r;
            switch (n.category) {
                case"shelf":
                    e = n.levels, t = "levels", r = n.description;
                    break;
                case"clapboard":
                    t = "type";
                    var i = "";
                    e * .5 == 2 && (i = "(×2)"), r = n.description + i;
                    break;
                case"accessory":
                    t = "type", r = n.description + " (L" + parseInt(n.tier + 1) + ")"
            }
            var s = '<tr descRole="' + n.category + '" ' + t + '="' + n[t] + '"><td>' + r + "</td></li>";
            $("#sca-selection-summary").append(s)
        })
    }, n.events.initBill = function (e) {
        $.each(e, function (e, t) {
            $.each(t, function (e, t) {
                var n = '<tr billRole="' + t.category + '" rid=' + t.id + ">" + '<td label="name">' + t.description + '</td><td label="price">' + t.price + "</td>" + '<td label="count">0</td><td label="gross">0</td></tr>';
                $("#sca-cart-bill").append(n), $("#sca-cart-bill tr:last").data("data", t)
            })
        })
    }, n.events.pickSheets = function (e) {
        var t = $("#produit_list_more"), r = $("#produit_list_main ul li");
        r.find("a").bind("click", function () {
            var i = $(this).parents("li").data("data");
            r.find("a").removeClass(), $(this).addClass("this"), t.find("ul:lt(2) li a").removeClass("this"), n.events.initSelection(i), n.events.initAccessoryOptions2(e), $("#sca-tagCategory").hide(), t.find("ul:gt(1)").hide().find("li a").removeClass("this"), n.events.initPreviewFull(i.dir, [0, 0], [0, 0]), n.events.initSelectDescribe()
        })
    }, n.events.pickClapboard = function () {
        var e = $("#produit_list_more").find("ul:lt(2) li:gt(0)");
        e.find("a").bind("click", function () {
            var e = !1, t = $(this).parents("li").data("data"), r = $("li[selectRole=" + t.category + "][type=" + t.type + "]"), i = $("li[descRole=" + t.category + "][type=" + t.type + "]"), s = $("li[selectRole=shelf]").data("data").levels, o = n.config.Clapboards.dir + "/" + t.icon + n.config.suffixPng;
            if ($(this).attr("class") == "this")e = !1, $(this).removeClass("this"); else {
                if (n.config.isDiffrentColor == 1) {
                    var u = $("li[selectRole=" + t.category + "][type!=" + t.type + "]");
                    if (u[0] && u.data("data").color != t.color)return alert("背板和侧板颜色请保持一致"), !1
                }
                e = !0, $(this).addClass("this").parent("li").siblings("li").find("a[class*=this]").removeClass("this")
            }
            e == 1 ? function () {
                r[0] ? r.data("data", t).find("img").attr("src", o) : function () {
                    var e = '<li selectRole="' + t.category + '" type="' + t.type + '" class="rack1_plate1" style="padding-top: 12px; ">+<img src="' + o + '" height="48"></li>';
                    $("#nav ul").append(e), $("#nav ul").find("li:last").data("data", t)
                }()
            }() : function () {
                r.remove(), $("li[selectRole=" + t.category + "]")[0] || $("li[selectRole]:gt(0)").remove()
            }();
            var a = $("#produit_list_more").find("ul:gt(1)"), f = $("#sca-tagCategory");
            e == 1 ? function () {
                f.show(), a.show()
            }() : function () {
                $("li[selectRole=" + t.category + "]")[0] || (f.hide(), a.hide().find("li a").removeClass("this"))
            }(), n.events.initSelectDescribe();
            var l = n.method.getImagePath();
            n.events.initPreviewFull(l.dir, l.clapboard, l.accessory)
        })
    }, n.events.pickClapboard2 = function () {
        var e = $("#produit_list_more").find("ul:lt(2) li:gt(0)");
        e.find("a").bind("click", function () {
            var t = !1, r = $(this).parents("li").data("data"), i = $("li[selectRole=" + r.category + "]");
            $(this).attr("class") == "this" ? (t = !1, $(this).removeClass("this"), $(this).parents("ul").siblings("ul:lt(1)").find("li:gt(0) a[class*=this]").removeClass("this")) : (t = !0, $("#produit_list_more ul:lt(2) li:gt(0) a[class*=this]").removeClass("this"), $(this).addClass("this"), $(this).parents("ul").siblings("ul:lt(1)").find("li:gt(0)").each(function () {
                var e = $(this).data("data");
                if (e.color == r.color)return $(this).find("a").addClass("this"), !1
            }));
            var s = e.find("a[class=this]").parents("li");
            t == 1 ? i[0] ? function () {
                s.each(function () {
                    var e = $(this).data("data"), t = e.category, r = e.type, i = e.icon, s = n.config.Clapboards.dir + "/" + i + n.config.suffixPng;
                    $("li[selectRole=" + t + "][type=" + r + "]").data("data", e).find("img").attr("src", s)
                })
            }() : function () {
                s.each(function () {
                    var e = $(this).data("data"), t = e.category, r = e.type, i = e.icon, s = n.config.Clapboards.dir + "/" + i + n.config.suffixPng, o = '<li selectRole="' + e.category + '" type="' + e.type + '" class="rack1_plate1" style="padding-top: 12px; ">+<img src="' + s + '" height="48"></li>';
                    $("#nav ul").append(o), $("#nav ul").find("li:last").data("data", e)
                })
            }() : $("li[selectRole]:gt(0)").remove();
            var o = $("#produit_list_more").find("ul:gt(1)"), u = $("#sca-tagCategory");
            t == 1 ? function () {
                u.show(), o.show()
            }() : function () {
                u.hide(), o.hide().find("li a").removeClass("this")
            }(), n.events.initSelectDescribe();
            var a = .5;
            n.events.initPreviewFull()
        })
    }, n.events.pickAccessory = function () {
        var e = $("#produit_list_more").find("ul:gt(1) li:gt(0)");
        e.find("a").live("click", function () {
            var e = !1, t = $(this).parents("li").data("data"), r = $("li[selectRole=" + t.category + "][tier=" + t.tier + "]"), i = $("li[descRole=" + t.category + "][tier=" + t.tier + "]"), s = n.config.Accessory.dir + "/" + t.icon + n.config.suffix;
            $(this).attr("class").indexOf("this") != -1 ? (e = !1, $(this).removeClass("this")) : (e = !0, $(this).addClass("this"), $(this).parent("li").siblings("li").find("a").removeClass("this")), e == 1 ? function () {
                r[0] ? r.data("data", t).find("img").attr("src", s) : function () {
                    var e = '<li selectRole="' + t.category + '" tier="' + t.tier + '" class="rack1_fitting2" style="padding-top: 27px; ">+<img src="' + s + '" height="32"></li>';
                    $("#nav ul").append(e), $("#nav ul").find("li:last").data("data", t)
                }()
            }() : r.remove(), n.events.initSelectDescribe();
            var o = .5;
            n.events.initPreviewFull()
        })
    }, n.events.saveSelection = function () {
        $("button[btnID=btnSave]").bind("click", function () {
            var e = $("li[selectRole=shelf]").data("data"), t = e.levels, r = $("#produit_list_more"), i = n.method.getSelection2(.5);
            r.find("ul:lt(2) li:gt(0) a[class*=this]").removeClass("this"), $("#sca-tagCategory").hide(), r.find("ul:gt(1)").hide().find("li:gt(0) a[class*=this]").removeClass("this"), $("tr[descRole]:gt(0)").remove();
            var s = n.method.setImagePath("middle"), o = s + n.config.suffixPng;
            if (n.CartItemId == -1) {
                n.Cart.push(i);
                var u = '<li><img src="' + o + '"><a btnID="delCart" href="###">×</a></li>';
                $("#cart-options").append(u)
            } else n.Cart.splice(n.CartItemId, 1, i), $("#cart-options li").eq(n.CartItemId).removeClass("checked").find("img").attr("src", o), n.CartItemId = -1;
            n.method.updateBillOptions(), $("#nav").find("ul li:gt(0)").remove(), n.events.initPreviewFull()
        })
    }, n.events.editCartOptions = function () {
        $("#cart-options").find("li img").live("click", function () {
            var e = $(this).parents("li"), r = !1;
            $("#sca-tagCategory").hide();
            if (e.attr("class") == "checked")return r = !1, n.CartItemId = -1, e.removeClass("checked"), n.method.cancelEdition(), !1;
            r = !0, e.siblings("li").removeClass("checked"), e.addClass("checked"), $("#nav ul").find("li").remove(), n.CartItemId = $(this).parents("li").index();
            var i = {side:!1, back:!1};
            $.each(n.Cart[n.CartItemId], function (e, t) {
                var r, s = null, o = null, u = n.config.suffixPng, a = 48, f = "padding-top: 12px", l = "+";
                switch (t.category) {
                    case"shelf":
                        r = t.dir, a = "auto", f = "", l = "";
                        break;
                    case"clapboard":
                        if (i[t.type])return!0;
                        i[t.type] = !0, r = n.config.Clapboards.dir, s = "type=" + t.type;
                        break;
                    case"accessory":
                        r = n.config.Accessory.dir, u = n.config.suffix, a = 32, s = "type=" + t.type, f = "padding-top:27px", o = "tier=" + t.tier
                }
                var c = r + "/" + t.icon + u, h = '<li selectrole="' + t.category + '" ' + s + " " + o + ' style="' + f + '">' + l + '<img src="' + c + '" height="' + a + '"></li>';
                $("#nav ul").append(h).find("li:last").data("data", t)
            });
            var s = $("li[selectRole=shelf]").data("data"), o = s.levels, u = s.id;
            $("#produit_list_main ul li").each(function () {
                $(this).find("a").removeClass("this");
                var e = $(this).data("data");
                e.id == u && $(this).find("a").addClass("this")
            });
            var a = $("#produit_list_more ul:lt(2)").find("li:gt(0)");
            a.find("a[class*=this]").removeClass("this"), $("li[selectRole=clapboard]").each(function () {
                var e = $(this).data("data");
                a.each(function () {
                    var t = $(this).data("data");
                    t.id == e.id && $(this).find("a").addClass("this")
                })
            }), n.events.initAccessoryOptions2(t.Accessories), $("li[selectRole=clapboard]")[0] && ($("#sca-tagCategory").show(), $("#produit_list_more ul:gt(1)").show());
            var f = $("#produit_list_more ul:gt(1)").find("li:gt(0)");
            $("li[selectRole=accessory]").each(function () {
                var e = $(this).data("data");
                f.each(function () {
                    var t = $(this).data("data");
                    t.id == e.id && t.tier == e.tier && $(this).find("a").addClass("this")
                })
            }), n.events.initSelectDescribe(), n.events.initPreviewFull()
        })
    }, n.events.cancelCartOptions = function () {
        $("a[btnID=delCart]").live("click", function () {
            var e = $(this).parents("li").index();
            n.CartItemId > -1 && (n.method.cancelEdition(), n.CartItemId = -1), $(this).parents("li").remove(), n.Cart.splice(e, 1), n.method.updateBillOptions()
        })
    }, n.events.backToEdition = function () {
        $("#sca-drager li").bind("dblclick", function () {
            $.fancybox.close(), n.CartItemId = parseInt($(this).attr("sid")), $("#cart-options li").removeClass("checked").eq(n.CartItemId).find("img").trigger("click")
        })
    }, n.events.cartPreview = function () {
        $("button[btnID=showCartPreview]").bind("click", function () {
            $.fancybox('<div id="sca-dragWrap"><ul id="sca-drager" class="sca-cart-iconList"></ul></div>', {onComplete:function () {
                $("#sca-dragWrap").parent("div").removeAttr("style"), $("#cart-options li img").each(function () {
                    var e = $(this).parents("li").index(), t = "<li sid=" + e + '><img src="' + $(this).attr("src") + '" width="250" ></li>';
                    $("#sca-drager").append(t), $("#sca-drager li img").aeImageResize({height:250, width:250})
                }), $("#sca-drager li").length > 6 ? $("#sca-drager").css({height:"auto"}) : null, $("#sca-drager").sortable({opacity:.6, revert:!0, cursor:"move"}), n.events.backToEdition()
            }})
        })
    }, n.events.requestBill = function () {
        $("button[btnID=requestBill]").bind("click", function () {
            var e = new Array;
            $("tr[billrole]").find("td[label=count]").each(function () {
                var t = $(this).parent("tr"), n = parseInt($(this).text());
                if (n > 0) {
                    var r = t.attr("rid"), i = t.attr("billRole");
                    e.push({id:r, category:i, count:n})
                }
            }), e.length > 0 && (console.log(e), $.ajax({url:n.config.requestURL, data:e, success:function (e) {
                alert(e)
            }}))
        })
    }, $(function () {
        n.events.initSelection(t.Shelf[0]), n.events.initSheets(t.Shelf), n.events.initClapboardOptions(t.Clapboards), n.events.initAccessoryOptions2(t.Accessories), n.events.initSelectDescribe(), n.events.initBill(t), n.events.initPreviewFull(t.Shelf[0].dir, [0, 0], [0, 0]), n.method.setCartPosition(), n.events.pickSheets(t.Accessories), n.events.pickClapboard(), n.events.pickAccessory(), n.events.saveSelection(), n.events.editCartOptions(), n.events.cancelCartOptions(), n.events.cartPreview(), n.events.requestBill()
    })
})(Combination);